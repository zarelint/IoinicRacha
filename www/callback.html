<html>
<head>
    <script src="lib/ionic/js/ionic.bundle.js"></script>
    <script>
        var clientSecret = "SomeRandomCharsAndNumbers";
        var clientId = "android";

        var getJSON = function(url, successHandler, errorHandler) {
            var xhr = new XMLHttpRequest();
            xhr.open('get', url, true);
            xhr.responseType = 'json';

            xhr.onload = function() {
                var status = xhr.status;
                if (status == 200) {
                    successHandler && successHandler(xhr.response);
                } else {
                    errorHandler && errorHandler(status);
                }
            };
            xhr.send();
        };

        var postJSON = function postJSON(url, params, callback){
            function formatParams( params ){
                return   Object
                                .keys(params)
                                .map(function(key){
                                    return key+"="+params[key]
                                })
                                .join("&")
            }

            var xhr = new XMLHttpRequest();
            xhr.open("POST", url);
            //Send the proper header information along with the request
            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    callback(xhr.responseText);
                }
            };
            xhr.send(formatParams( params ));
        };



        var doc_url = (document.URL)+'';
        if (doc_url !== undefined ) {
            var callbackResponse = doc_url.split("#")[1];
            var responseParameters = (callbackResponse).split("&");
            var parameterMap = [];
            for (var i = 0; i < responseParameters.length; i++) {
                parameterMap[responseParameters[i].split("=")[0]] = responseParameters[i].split("=")[1];
            }
        }


        if(parameterMap.access_token !== undefined && parameterMap.access_token !== null) {
            accessToken= parameterMap.access_token;

            var email, password;
          //  https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=ya29.igJ0Ie8KO5UxfsVDWeCyAJZpy-wFxHMUmFa2RFYd0FoY4sl4DcEoXU4qyofGnab3tmNCi2A
           //sub: "112882507293155588376" (id)
            // Get user google mail,password
            getJSON('https://www.googleapis.com/oauth2/v1/userinfo?access_token=' +accessToken
                    , function(data) {
                        email = data.email;
                        password = data.id;


                        var parametros = {
                                grant_type:'password',
                                client_id:clientId,
                                client_secret:clientSecret,
                                username:email,
                                password:password
                                };

                    console.log(parametros);

                       //postJSON('http://nodejs-rachas.rhcloud.com/api/oauth/token/', parametros
                       postJSON('http://localhost:8080/api/oauth/token/', parametros
                                , function(data) {
                                    console.log(JSON.parse(data).access_token);
                                    window.localStorage.setItem("access_token",  JSON.parse(data).access_token);
                                    window.location.href = "http://localhost:63342/IoinicRacha/www/index.html#/tab/tips";

                                }, function(status) {
                                    alert('Something went wrong. Rachas Auth token server'+status);
                                });


            }, function(status) {
                alert('Something went wrong. google api  is not responding'+status);
            });



        } else {
            alert( 'problemas autentificacion');
            window.location.href = "http://localhost:63342/IoinicRacha/www/index.html#/tab/ligas";
        }

    </script>

</head>
<body >
Redirecting...</body>
</html>
